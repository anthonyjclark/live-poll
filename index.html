<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <link rel="stylesheet" type="text/css" href="pico.yellow.min.css">
    <script src="utilities.js"></script>
    <title>Live Poll</title>
    <style>
        .poll {
            max-width: min(100vw, 400px);
            margin: auto;
        }

        .results {
            margin-top: 2em;
        }
    </style>
</head>

<body>

    <main class="container">
        <div class="poll">
            <h1>Live Poll</h1>
            <h2 id="poll-question">Loading poll...</h2>
            <form id="poll-form"></form>
            <!-- <div id="timer-area"><strong>Time remaining:</strong> <span id="timer-display">00:00</span></div> -->
            <button id="poll-button" disabled>Submit</button>
            <div id="poll-results" class="results"></div>
        </div>
    </main>

    <script>

        //
        // Global state
        //

        let previousState = null;
        let voted = false;

        const questionDiv = document.getElementById('poll-question');
        const form = document.getElementById('poll-form');
        const pollButton = document.getElementById('poll-button');
        const resultsDiv = document.getElementById('poll-results');

        function renderQuestions(state) {
            questionDiv.textContent = state.question;
            form.innerHTML = '';
            for (const [i, question] of state.questions.entries()) {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" name="option" value="${i}"><span>${question}</span>`;
                form.appendChild(label);
            }
        }

        function fetchState() {
            fetch('state.php')
                .then(res => res.json())
                .then(state => {
                    if (stateChanged(previousState, state)) console.log('State changed:', state);

                    if (!previousState || previousState.timestamp !== state.timestamp) {
                        renderQuestions(state);
                        resultsDiv.innerHTML = renderResults(state);

                        voted = false;
                        pollButton.disabled = true;
                        pollButton.textContent = 'Submit';

                    }

                    updateResults(state, resultsDiv);
                    updateVotedStatus(state);
                    previousState = state;
                });
        }

        function updateVotedStatus(state) {
            const storedTimestamp = parseFloat(localStorage.getItem('vote_timestamp') || 0);
            if (storedTimestamp !== state.timestamp) return;
            voted = true;
            pollButton.disabled = true;
            pollButton.textContent = 'Already Voted';
            Array.from(form.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.disabled = true);
        }

        function handleVote() {
            // Update local vote immediately for better user experience
            voted = true;
            pollButton.disabled = true;
            pollButton.textContent = 'Already Voted';
            Array.from(form.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.disabled = true);

            const checked = Array.from(form.querySelectorAll('input[type=checkbox]:checked'));
            const tempState = JSON.parse(JSON.stringify(previousState));
            checked.forEach(cb => { tempState.votes[parseInt(cb.value)] += 1; });
            updateResults(tempState, resultsDiv);

            const selections = checked.map(cb => parseInt(cb.value));

            fetch('state.php', {
                method: 'POST',
                body: JSON.stringify({ vote: selections }),
                headers: { 'Content-Type': 'application/json' },
            })
                .then(res => res.json())
                .then(status => {
                    if (status.success) localStorage.setItem('vote_timestamp', previousState.timestamp);
                    // NOTE: What if not successful?
                });
        }

        function handleSelections() {
            const checked = Array.from(form.querySelectorAll('input[type=checkbox]:checked'));
            pollButton.disabled = checked.length === 0 || voted;
        };

        form.onchange = handleSelections;
        pollButton.onclick = handleVote;

        fetchState();
        setInterval(fetchState, 2000);
    </script>
</body>

</html>
