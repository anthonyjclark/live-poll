<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <link rel="stylesheet" type="text/css" href="css/pico.yellow.min.css">
    <title>Live Poll</title>
    <style>
        .poll {
            max-width: min(100vw, 400px);
            margin: auto;
        }

        .results {
            margin-top: 2em;
        }
    </style>
</head>

<body>

    <main class="container">
        <div class="poll">
            <h1 id="question">Loading poll...</h1>
            <div id="timer-area"><strong>Time:</strong> <span id="timer-display">00:00</span></div>
            <form id="poll-form"></form>
            <button id="vote-button" disabled>Submit</button>
            <div id="results" class="results"></div>
        </div>
    </main>

    <script>

        //
        // Utilities (maybe refactor into a separate module)
        //

        function formatTime(secs) {
            secs = Math.max(0, parseInt(secs, 10) || 0);
            const m = Math.floor(secs / 60);
            const s = secs % 60;
            return (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
        }


        //
        // Global state
        //

        // Refactor to remove global variables if possible
        let selectedOptions = [];
        let lastTimestamp = null;
        let lastPollData = null;

        const form = document.getElementById('poll-form');
        const voteButton = document.getElementById('vote-button');
        const resultsDiv = document.getElementById('results');

        voteButton.onclick = handleVote;


        function updateResults(data) {
            const total = data.options.reduce((sum, o) => sum + o.votes, 0);
            resultsDiv.innerHTML = '<h3>Results</h3>';
            for (const opt of data.options) {
                const percent = total ? Math.round((opt.votes / total) * 100) : 0;
                const voteLabel = opt.votes === 1 ? "vote" : "votes";
                resultsDiv.innerHTML += `<div>${opt.text}: ${opt.votes} ${voteLabel} <progress value="${percent}" max="100"></progress></div>`;
            }
        }

        function hasVoted(data) {
            const version = data && data.timestamp;
            return version && localStorage.getItem('vote_timestamp') === version;
        }

        function pollDataChanged(newData) {
            if (!lastPollData) return true;
            if (lastPollData.question !== newData.question) return true;
            if (lastPollData.timestamp !== newData.timestamp) return true;
            if (lastPollData.options.length !== newData.options.length) return true;
            for (let i = 0; i < newData.options.length; i++) {
                if (lastPollData.options[i].text !== newData.options[i].text) return true;
                if (lastPollData.options[i].votes !== newData.options[i].votes) return true;
            }
            return false;
        }


        function renderPoll(data) {
            document.getElementById('question').textContent = data.question;
            form.innerHTML = '';

            if (lastTimestamp !== null && data.timestamp !== lastTimestamp) {
                selectedOptions = [];
                localStorage.removeItem('vote_timestamp');
            }

            lastTimestamp = data.timestamp;

            const voted = hasVoted(data);

            for (const [i, opt] of data.options.entries()) {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" name="option" value="${i}"${voted ? ' disabled' : ''}><span>${opt.text}</span>`;
                form.appendChild(label);
            }

            form.addEventListener('change', function () {
                const checked = Array.from(form.querySelectorAll('input[type=checkbox]:checked'));
                selectedOptions = checked.map(cb => parseInt(cb.value));
                voteButton.disabled = checked.length === 0 || voted;
            });

            voteButton.disabled = voted || selectedOptions.length === 0;
        }

        function fetchDataAndRender(localVote) {
            fetch('update.php')
                .then(res => res.json())
                .then(data => {
                    if (pollDataChanged(data)) {
                        if (localVote === false) renderPoll(data);
                        updateResults(data);
                        lastPollData = JSON.parse(JSON.stringify(data));
                    }
                });
        }

        function handleVote() {
            fetch('update.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vote: selectedOptions })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (lastPollData && lastPollData.timestamp) localStorage.setItem('vote_timestamp', lastPollData.timestamp);
                        fetchDataAndRender(true);
                        voteButton.disabled = true;
                    }
                });
        }

        // Initial load and then poll every 2 seconds
        fetchDataAndRender(false);
        setInterval(fetchDataAndRender, 2000);
    </script>
</body>

</html>
