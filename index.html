<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <link rel="stylesheet" type="text/css" href="css/pico.classless.yellow.min.css">
    <title>Live Poll</title>
    <style>
        .poll {
            max-width: min(100vw, 400px);
            margin: auto;
        }

        .results {
            margin-top: 2em;
        }
    </style>
</head>

<body>

    <main>
        <div class="poll">
            <h1 id="question">Loading poll...</h1>
            <form id="pollForm"></form>
            <button id="voteBtn" disabled>Vote</button>
            <div id="results" class="results"></div>
        </div>
    </main>

    <script>
        let selectedOption = null;
        let pollData = null;
        let lastResetVersion = null;

        function fetchPoll() {
            fetch('get_poll.php')
                .then(res => res.json())
                .then(data => {
                    pollData = data;
                    document.getElementById('question').textContent = data.question;
                    const form = document.getElementById('pollForm');
                    form.innerHTML = '';
                    data.options.forEach((opt, i) => {
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="checkbox" name="option" value="${i}"><span>${opt.text}</span>`;
                        form.appendChild(label);
                    });
                    form.addEventListener('change', e => {
                        const checked = Array.from(form.querySelectorAll('input[type=checkbox]:checked'));
                        selectedOption = checked.map(cb => parseInt(cb.value));
                        document.getElementById('voteBtn').disabled = checked.length === 0 || hasVoted();
                    });
                    // Clear selections if reset_version changed
                    if (lastResetVersion !== null && data.reset_version !== lastResetVersion) {
                        selectedOption = [];
                        Array.from(form.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = false);
                        document.getElementById('voteBtn').disabled = true;
                        localStorage.removeItem('poll_voted_version');
                    }
                    lastResetVersion = data.reset_version;
                    // Disable vote button if already voted for this version
                    if (hasVoted()) {
                        document.getElementById('voteBtn').disabled = true;
                    }
                });
        }

        function fetchResults() {
            fetch('get_poll.php')
                .then(res => res.json())
                .then(data => {
                    showResults(data);
                    // Clear selections if reset_version changed
                    if (lastResetVersion !== null && data.reset_version !== lastResetVersion) {
                        selectedOption = [];
                        const form = document.getElementById('pollForm');
                        Array.from(form.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = false);
                        document.getElementById('voteBtn').disabled = true;
                        localStorage.removeItem('poll_voted_version');
                    }
                    lastResetVersion = data.reset_version;
                    // Disable vote button if already voted for this version
                    if (hasVoted()) {
                        document.getElementById('voteBtn').disabled = true;
                    }
                });
        }

        function showResults(data) {
            const total = data.options.reduce((sum, o) => sum + o.votes, 0);
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>Results</h3>';
            data.options.forEach(opt => {
                const percent = total ? Math.round((opt.votes / total) * 100) : 0;
                const voteLabel = opt.votes === 1 ? "vote" : "votes";
                resultsDiv.innerHTML += `<div>${opt.text}: ${opt.votes} ${voteLabel} <progress value="${percent}" max="100"></progress></div>`;
            });
        }

        function hasVoted() {
            const version = pollData && pollData.reset_version;
            return version && localStorage.getItem('poll_voted_version') === version;
        }

        document.getElementById('voteBtn').onclick = function () {
            if (!Array.isArray(selectedOption) || selectedOption.length === 0 || hasVoted()) return;
            fetch('vote.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ option_indexes: selectedOption })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // Mark as voted for this version
                        if (pollData && pollData.reset_version) {
                            localStorage.setItem('poll_voted_version', pollData.reset_version);
                        }
                        fetchResults();
                        document.getElementById('voteBtn').disabled = true;
                    }
                });
        };

        // Initial load
        fetchPoll();
        fetchResults();
        // Poll for results every 2 seconds
        setInterval(fetchResults, 2000);
    </script>
</body>

</html>
